<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>æˆ‘çš„æ—…éŠè³‡æ–™åº«</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  onSnapshot, deleteDoc, doc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ğŸ”´ æ›æˆä½ è‡ªå·±çš„ FirebaseConfig */
const firebaseConfig = {
  apiKey: "AIzaSy......",
  authDomain: "travel-plan-80111.firebaseapp.com",
  projectId: "travel-plan-80111",
  storageBucket: "travel-plan-80111.firebasestorage.app",
  messagingSenderId: "598566081827",
  appId: "1:598566081827:web:57aeb8f456a0c37b1be896"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const colRef = collection(db, "trips");

let currentFilter = "all";
let editId = null;

/* ç¯©é¸ */
window.setFilter = f => currentFilter = f;

/* å³æ™‚åŒæ­¥é¡¯ç¤º */
onSnapshot(colRef, snap => render(snap.docs.map(d=>({id:d.id,...d.data()}))));

function render(data){
  const list = document.getElementById("list");
  list.innerHTML = "";

  data = data.filter(d=>{
    if(currentFilter==="domestic") return d.region==="åœ‹å…§";
    if(currentFilter==="foreign") return d.region==="åœ‹å¤–";
    if(currentFilter==="visited") return d.visitDate;
    if(currentFilter==="unvisited") return !d.visitDate;
    return true;
  }).sort((a,b)=>(b.visitDate||"").localeCompare(a.visitDate||""));

  data.forEach(d=>{
    const links = (d.links||[]).map((l,i)=>
      `<a href="${l}" target="_blank">é€£çµ${i+1}</a>`
    ).join(" Â· ");

    list.innerHTML += `
    <div class="card">
      <h3>${d.title}</h3>
      <div class="meta">${d.region}ï½œ${d.place}</div>
      <div class="date">${d.visitDate ? "âœ” å·²è¨ªï¼š"+d.visitDate : "â³ æœªè¨ª"}</div>
      <div>${d.content||""}</div>
      <div class="links">${links}</div>
      <button onclick="loadEdit('${d.id}')">âœï¸ ç·¨è¼¯</button>
      <button onclick="del('${d.id}')">ğŸ—‘ åˆªé™¤</button>
    </div>`;
  });
}

/* æ–°å¢ / æ›´æ–° */
window.save = async ()=>{
  const links = link.value.split("\n").map(l=>l.trim()).filter(Boolean);
  const data = {
    title: title.value,
    place: place.value,
    region: region.value,
    content: content.value,
    links,
    visitDate: visitDate.value
  };

  if(editId){
    await updateDoc(doc(db,"trips",editId),data);
    editId=null;
  }else{
    await addDoc(colRef,data);
  }
  clearForm();
};

/* ç·¨è¼¯ */
window.loadEdit = async id=>{
  const snap = await getDocs(colRef);
  snap.forEach(d=>{
    if(d.id===id){
      const x=d.data();
      title.value=x.title;
      place.value=x.place;
      region.value=x.region;
      content.value=x.content;
      visitDate.value=x.visitDate||"";
      link.value=(x.links||[]).join("\n");
      editId=id;
    }
  });
};

/* åˆªé™¤ */
window.del = async id=>{
  if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await deleteDoc(doc(db,"trips",id));
};

/* æ¸…ç©º */
function clearForm(){
  title.value=place.value=content.value=link.value=visitDate.value="";
}

/* Excel åŒ¯å‡º */
window.exportExcel = async ()=>{
  const snap = await getDocs(colRef);
  const rows=[];
  snap.forEach(d=>{
    const x=d.data();
    rows.push({
      æ¨™é¡Œ:x.title,
      åœ°é»:x.place,
      å€åŸŸ:x.region,
      å…§å®¹:x.content,
      å·²è¨ªæ—¥æœŸ:x.visitDate,
      åƒè€ƒç¶²å€:(x.links||[]).join(" | ")
    });
  });
  const ws=XLSX.utils.json_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"æ—…éŠè³‡æ–™");
  XLSX.writeFile(wb,"travel.xlsx");
};

/* Excel åŒ¯å…¥ */
window.importExcel = ()=>{
  const file=document.getElementById("excel").files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=async e=>{
    const wb=XLSX.read(e.target.result,{type:"binary"});
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    for(const r of rows){
      await addDoc(colRef,{
        title:r["æ¨™é¡Œ"],
        place:r["åœ°é»"],
        region:r["å€åŸŸ"],
        content:r["å…§å®¹"],
        visitDate:r["å·²è¨ªæ—¥æœŸ"],
        links:(r["åƒè€ƒç¶²å€"]||"").split("|").map(s=>s.trim()).filter(Boolean)
      });
    }
    alert("åŒ¯å…¥å®Œæˆ");
  };
  reader.readAsBinaryString(file);
};
</script>

<style>
body{font-family:sans-serif;background:#f5f6f7;padding:16px}
.card{background:#fff;padding:16px;border-radius:12px;margin-bottom:12px}
h3{margin:0}
.meta{color:#666}
.date{color:#0a7}
.links a{font-size:14px}
button{margin-right:6px}
</style>
</head>

<body>

<h1>ğŸ“ æˆ‘çš„æ—…éŠè³‡æ–™åº«</h1>

<div>
  <button onclick="setFilter('all')">å…¨éƒ¨</button>
  <button onclick="setFilter('domestic')">åœ‹å…§</button>
  <button onclick="setFilter('foreign')">åœ‹å¤–</button>
  <button onclick="setFilter('visited')">å·²è¨ª</button>
  <button onclick="setFilter('unvisited')">æœªè¨ª</button>
</div>

<div class="card">
  <input id="title" placeholder="æ¨™é¡Œ">
  <input id="place" placeholder="åœ°é»">
  <select id="region"><option>åœ‹å…§</option><option>åœ‹å¤–</option></select>
  <input id="visitDate" type="date">
  <textarea id="content" placeholder="å…§å®¹"></textarea>
  <textarea id="link" placeholder="åƒè€ƒç¶²å€ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰"></textarea>
  <button onclick="save()">ğŸ’¾ å„²å­˜</button>
</div>

<div class="card">
  <input type="file" id="excel">
  <button onclick="importExcel()">ğŸ“¤ åŒ¯å…¥</button>
  <button onclick="exportExcel()">ğŸ“¥ åŒ¯å‡º</button>
</div>

<div id="list"></div>

</body>
</html>
