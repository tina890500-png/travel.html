<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ğŸ“ æˆ‘çš„æ—…éŠè³‡æ–™åº«</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:#f5f6f7;
  padding:16px;
  margin:0;
}
h1{text-align:center;margin-bottom:12px}
.tabs button{margin-right:6px;margin-bottom:8px}
.card{
  background:#fff;
  border-radius:14px;
  padding:16px;
  margin-bottom:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}
label{font-size:14px;color:#555}
input,select,textarea{
  width:100%;
  padding:10px;
  margin:6px 0 12px;
  font-size:16px;
}
.meta{color:#666}
.date{color:#0a7;font-size:14px}
.note{white-space:pre-wrap}
.links a{font-size:14px;margin-right:6px}
.actions button{margin-right:6px}

.save-row{
  display:flex;
  align-items:center;
  gap:12px;
}
.saved-text{
  color:#0a7;
  font-size:14px;
  display:none;
}
</style>
</head>

<body>

<h1>ğŸ“ æˆ‘çš„æ—…éŠè³‡æ–™åº«</h1>

<div class="tabs">
  <button onclick="setTab('all')">å…¨éƒ¨</button>
  <button onclick="setTab('domestic')">åœ‹å…§</button>
  <button onclick="setTab('foreign')">åœ‹å¤–</button>
  <button onclick="setTab('visited')">å·²è¨ª</button>
  <button onclick="setTab('unvisited')">æœªè¨ª</button>
</div>

<!-- æ–°å¢ / ç·¨è¼¯è¡¨å–® -->
<div class="card">
  <label>åœ‹å…§ / åœ‹å¤–</label>
  <select id="region">
    <option>åœ‹å…§</option>
    <option>åœ‹å¤–</option>
  </select>

  <label>åœ°å€</label>
  <input id="location" placeholder="ä¾‹å¦‚ï¼šæ¡ƒåœ’ / äº¬éƒ½">

  <label>æ¨™é¡Œ</label>
  <input id="title" placeholder="ä¾‹å¦‚ï¼šæ–°èˆˆå¿«ç‚’åº—">

  <label>å·²è¨ªæ—¥æœŸ</label>
  <input id="date" type="date">

  <label>å…§å®¹</label>
  <textarea id="note" rows="3"></textarea>

  <label>åƒè€ƒç¶²å€ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰</label>
  <textarea id="links" rows="2"></textarea>

  <div class="save-row">
    <button onclick="save()">ğŸ’¾ å„²å­˜</button>
    <span id="savedText" class="saved-text">âœ” å·²å„²å­˜</span>
  </div>
</div>

<!-- Excel -->
<div class="card">
  <button onclick="exportExcel()">Excel åŒ¯å‡º</button>
  <input type="file" id="excel" style="margin-left:12px">
  <button onclick="importExcel()">Excel åŒ¯å…¥</button>
</div>

<!-- æ¸…å–® -->
<div id="list"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
  getFirestore, collection, addDoc,
  onSnapshot, deleteDoc, doc, updateDoc, getDocs
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyClxWYydZU6HkXO86nK4cA36Rz0MyhjSYw",
  authDomain: "travel-plan-8e011.firebaseapp.com",
  projectId: "travel-plan-8e011",
  storageBucket: "travel-plan-8e011.firebasestorage.app",
  messagingSenderId: "598566081827",
  appId: "1:598566081827:web:57aeb8f456a0c37b1be896"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const colRef = collection(db,"trips");

let allData=[];
let currentTab="all";
let editId=null;

window.setTab=t=>{currentTab=t;render();};

onSnapshot(colRef,snap=>{
  allData=snap.docs.map(d=>({id:d.id,...d.data()}));
  render();
});

function render(){
  const list=document.getElementById("list");
  list.innerHTML="";

  let data=allData.filter(d=>{
    if(currentTab==="domestic")return d.region==="åœ‹å…§";
    if(currentTab==="foreign")return d.region==="åœ‹å¤–";
    if(currentTab==="visited")return d.date;
    if(currentTab==="unvisited")return !d.date;
    return true;
  }).sort((a,b)=>(b.date||"").localeCompare(a.date||""));

  data.forEach(d=>{
    const linkHtml=(d.links||[]).map((l,i)=>
      `<a href="${l}" target="_blank">é€£çµ${i+1}</a>`
    ).join("");

    list.innerHTML+=`
      <div class="card">
        <h3>${d.title}</h3>
        <div class="meta">${d.region}ï½œ${d.location}</div>
        <div class="date">${d.date ? "âœ” å·²è¨ªï¼š"+d.date : "â³ æœªè¨ª"}</div>
        <div class="note">${d.note||""}</div>
        <div class="links">${linkHtml}</div>
        <div class="actions">
          <button onclick="edit('${d.id}')">âœï¸ ç·¨è¼¯</button>
          <button onclick="del('${d.id}')">ğŸ—‘ åˆªé™¤</button>
        </div>
      </div>`;
  });
}

window.save=async()=>{
  const data={
    region:region.value,
    location:location.value,
    title:title.value,
    date:date.value,
    note:note.value,
    links:links.value.split("\n").map(l=>l.trim()).filter(Boolean)
  };

  if(editId){
    await updateDoc(doc(db,"trips",editId),data);
    editId=null;
  }else{
    await addDoc(colRef,data);
  }

  document.getElementById("savedText").style.display="inline";
  setTimeout(()=>document.getElementById("savedText").style.display="none",2000);

  clearForm();
};

window.edit=id=>{
  const d=allData.find(x=>x.id===id);
  region.value=d.region;
  location.value=d.location;
  title.value=d.title;
  date.value=d.date||"";
  note.value=d.note||"";
  links.value=(d.links||[]).join("\n");
  editId=id;
};

window.del=async id=>{
  if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")){
    await deleteDoc(doc(db,"trips",id));
  }
};

window.exportExcel=async()=>{
  const snap=await getDocs(colRef);
  const rows=[];
  snap.forEach(d=>{
    const x=d.data();
    rows.push({
      å€åŸŸ:x.region,
      åœ°å€:x.location,
      æ¨™é¡Œ:x.title,
      å·²è¨ªæ—¥æœŸ:x.date,
      å…§å®¹:x.note,
      åƒè€ƒç¶²å€:(x.links||[]).join(" | ")
    });
  });
  const ws=XLSX.utils.json_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"æ—…éŠè³‡æ–™");
  XLSX.writeFile(wb,"travel.xlsx");
};

window.importExcel=()=>{
  const file=document.getElementById("excel").files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=async e=>{
    const wb=XLSX.read(e.target.result,{type:"binary"});
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    for(const r of rows){
      await addDoc(colRef,{
        region:r["å€åŸŸ"],
        location:r["åœ°å€"],
        title:r["æ¨™é¡Œ"],
        date:r["å·²è¨ªæ—¥æœŸ"],
        note:r["å…§å®¹"],
        links:(r["åƒè€ƒç¶²å€"]||"").split("|").map(s=>s.trim()).filter(Boolean)
      });
    }
  };
  reader.readAsBinaryString(file);
};

function clearForm(){
  region.value="åœ‹å…§";
  location.value=title.value=date.value=note.value=links.value="";
}
</script>

</body>
</html>
